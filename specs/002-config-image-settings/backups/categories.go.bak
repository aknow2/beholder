package storage

import (
	"database/sql"
	"encoding/json"
	"time"

	"github.com/aknow2/beholder/internal/config"
)

func (s *Store) UpsertCategories(categories []config.CategoryConfig) error {
	return withTx(s.DB, func(tx *sql.Tx) error {
		for _, c := range categories {
			examplesJSON, _ := json.Marshal(c.Examples)
			now := time.Now().UTC().Format(time.RFC3339)
			_, err := tx.Exec(`INSERT INTO categories (id, name, description, examples, color, created_at, updated_at)
				VALUES (?, ?, ?, ?, ?, ?, ?)
				ON CONFLICT(id) DO UPDATE SET
				name=excluded.name,
				description=excluded.description,
				examples=excluded.examples,
				color=excluded.color,
				updated_at=excluded.updated_at`,
				c.ID, c.Name, c.Description, string(examplesJSON), c.Color, now, now)
			if err != nil {
				return err
			}
		}
		return nil
	})
}
