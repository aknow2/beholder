# Implementation Plan: 設定ベースの画像管理とストレージ簡素化

**Branch**: `002-config-image-settings` | **Date**: 2026-01-28 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/002-config-image-settings/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Config.yamlに画像管理設定（max_width, max_files, save_images, format）を追加し、データベーススキーマを簡素化（categories/settingsテーブル削除、Event.category_idをcategory_nameに変更）、DBパスを~/.beholder/beholder.dbにデフォルト変更する。技術的にはGo 1.24、既存のinternal/config、internal/storage、internal/appパッケージを修正し、憲法原則（Configuration-Driven、Modular Architecture）に準拠する。

## Technical Context

**Language/Version**: Go 1.24  
**Primary Dependencies**: modernc.org/sqlite, gopkg.in/yaml.v3, macOS sips/screencapture  
**Storage**: SQLite（~/.beholder/beholder.db）  
**Testing**: Go標準 `go test`（unit tests for config validation, storage schema）  
**Target Platform**: macOS 13+（主対象）、Windows/Linuxは既存対応済み  
**Project Type**: single（CLI構成）  
**Performance Goals**: 画像削除 <100ms（max_files=100の場合の削除処理全体）、Config検証 <10ms  
**Constraints**: 画像は~/.beholder/imgs/に保存、DB・画像・config全て~/.beholder/に集約、既存データマイグレーション不要（未リリース）  
**Scale/Scope**: 個人利用、最大1,000件/日

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle III: Configuration-Driven ✅ PASS
- **Requirement**: Runtime behavior controlled through YAML configuration files
- **This Feature**: 画像管理設定（max_width, max_files, save_images, format）をconfig.yamlで制御
- **Compliance**: 新設定セクションを追加し、バリデーション実装。ハードコード値を削除し設定ファイルに移行
- **Justification**: N/A（準拠）

### Principle I: Modular Architecture ✅ PASS
- **Requirement**: Organize code into focused internal packages with clear boundaries
- **This Feature**: 既存のinternal/config（設定読込）、internal/storage（スキーマ変更）、internal/app（画像削除ロジック）を修正
- **Compliance**: パッケージ境界を維持。config→storage→appの依存方向を保持
- **Justification**: N/A（準拠）

### Principle IV: Local-First & Privacy ✅ PASS
- **Requirement**: Default to local storage; minimize data retention; respect user privacy
- **This Feature**: 全データを~/.beholder/に集約、max_filesで画像自動削除、save_images: falseで画像保存無効化
- **Compliance**: ユーザー管理ディレクトリに集約、保存枚数制御を設定可能に
- **Justification**: N/A（準拠）

### Code Reduction (Simplification Principle) ✅ PASS
- **Requirement**: Simplicity - start simple, YAGNI principles（憲法 Technical Standards）
- **This Feature**: categories/settingsテーブル削除、UpsertCategories関数削除、categories.go/settings.go削除で約100行削減
- **Compliance**: 二重管理を解消し、Single Source of Truth（Config）に統一
- **Justification**: N/A（準拠）

**Summary**: All constitution principles satisfied. No gate violations.

## Project Structure

### Documentation (this feature)

```text
specs/002-config-image-settings/
├── plan.md              # This file
├── spec.md              # Feature specification
└── tasks.md             # To be generated by /speckit.tasks
```

### Source Code (repository root)

```text
internal/
├── config/
│   ├── config.go        # [MODIFY] Add ImageConfig struct, update Config struct
│   ├── validate.go      # [MODIFY] Add image settings validation
│   └── default.yaml     # [MODIFY] Add image section, update storage.path default
├── storage/
│   ├── db.go            # [MODIFY] Update path resolution (~/.beholder/ base)
│   ├── migrate.go       # [MODIFY] Remove categories/settings tables, update events schema
│   ├── models.go        # [MODIFY] Update Event model (category_id → category_name)
│   ├── events.go        # [MODIFY] Update InsertEvent, ListEventsByDate for new schema
│   ├── categories.go    # [DELETE] No longer needed
│   └── settings.go      # [DELETE] No longer needed
├── app/
│   ├── capture.go       # [MODIFY] Add image deletion logic, use Config.Image settings
│   └── record_once.go   # [MODIFY] Pass category name instead of ID
├── summary/
│   └── generate.go      # [MODIFY] Use category_name directly from events
└── classify/
    └── client.go        # [NO CHANGE] Returns category ID, mapping done in app layer

cmd/beholder/
└── cli.go               # [MODIFY] Update summary command to use category names

tests/
├── unit/
│   ├── config_test.go   # [ADD] Test ImageConfig validation
│   └── storage_test.go  # [ADD] Test new schema operations
└── integration/
    └── image_cleanup_test.go  # [ADD] Test max_files deletion logic
```

**Structure Decision**: Single project構成を維持。既存のinternal/パッケージを修正し、categories.go/settings.goを削除してコード簡素化。テストは既存のtests/構造に追加。

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**N/A** - No constitution violations. All changes align with existing principles (Configuration-Driven, Modular Architecture, Local-First, Simplicity).

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
